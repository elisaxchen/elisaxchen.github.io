function parseBrattle(e){const t={},o=e.querySelectorAll("div.presentation");for(const e of o){const o=e.querySelector("h2.movie-title a");if(!o)continue;const n=o.textContent.trim(),r=e.querySelector("div.showtimes");if(!r)continue;let l=null;for(const e of r.querySelectorAll("h3, p"))if("H3"===e.tagName){const t=e.textContent.trim().match(/(\w+\s+\d+)/);if(t){const e=`${t[1]}, ${(new Date).getFullYear()}`;l=new Date(e).toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"})}}else if("P"===e.tagName&&l){const o=Array.from(e.querySelectorAll("a")).map(e=>e.textContent.trim());if(!o.length)continue;t[l]||(t[l]=[]);const r=t[l].find(e=>e.title===n);r?r.times.push(...o):t[l].push({title:n,times:o})}}return{theater:"Brattle Theatre",logo:"https://placehold.co/200x80/000000/FFFFFF?text=Brattle",showings:t}}function parseCoolidge(e){const t={},o=e.querySelector("#films");if(!o)return{theater:"Coolidge Corner Theatre",logo:"...",showings:{}};let n=null;for(const e of o.children)if(e.matches("div.daily-marker")){const t=`${e.textContent.trim()}, ${(new Date).getFullYear()}`;n=new Date(t).toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"})}else if(e.matches("div.film-card")&&n){const o=e.querySelector("h3.film-card--title")?.textContent.trim(),r=Array.from(e.querySelectorAll(".film-card--showtimes a")).map(e=>e.textContent.trim());o&&r.length>0&&(t[n]||(t[n]=[]),t[n].push({title:o,times:r}))}return{theater:"Coolidge Corner Theatre",logo:"https://placehold.co/200x80/c0392b/FFFFFF?text=Coolidge",showings:t}}function parseSomerville(e){const t={},o=e.querySelectorAll(".movie-card");for(const e of o){const o=e.querySelector(".card-header h2 a")?.textContent.trim(),n=e.querySelector(".card-header .date");if(!o||!n)continue;let r="";for(const e of n.childNodes)if(8===e.nodeType){r=e.textContent.trim();break}if(!r)continue;const l=new Date(r).toLocaleDateString("en-US",{weekday:"long",month:"long",day:"numeric"}),i=Array.from(e.querySelectorAll(".showtimes-list a.showtime")).map(e=>e.textContent.trim());i.length>0&&(t[l]||(t[l]=[]),t[l].push({title:o,times:i}))}return{theater:"Somerville Theatre",logo:"https://placehold.co/200x80/2980b9/FFFFFF?text=Somerville",showings:t}}async function main(){const e=Deno.args,t=e.pop(),o=e;0!==o.length&&t||(console.error("Usage: deno run --allow-read --allow-write postprocess.js <input1.html> [input2.html...] <output.json>"),Deno.exit(1));const n=[];for(const e of o){console.log(`Processing ${e}...`);const t=await Deno.readTextFile(e),o=(new DOMParser).parseFromString(t,"text/html");o?e.includes("brattle")?n.push(parseBrattle(o)):e.includes("coolidge")?n.push(parseCoolidge(o)):e.includes("somerville")&&n.push(parseSomerville(o)):console.error(`Failed to parse ${e}`)}const r={};for(const e of n)for(const[t,o]of Object.entries(e.showings))r[t]||(r[t]=[]),r[t].push({theater:e.theater,logo:e.logo,movies:o});console.log(`Writing combined schedule to ${t}...`),await Deno.writeTextFile(t,JSON.stringify(r,null,2)),console.log("All scraping complete.")}import{DOMParser}from"https://deno.land/x/deno_dom/deno-dom-wasm.ts";main();